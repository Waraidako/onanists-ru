#### Система команд ATmega8515

* **Пересылки**
  * Регистр-память - LD, ST, LPM, SPM
  * Регистр-регистр - MOV, IN, OUT
    ![IMG_20250227_124724.jpg](%D0%9F%D0%B8%D0%BA%D1%87%D0%B8/%D0%9B%D0%B5%D0%BA%D1%86%D0%B8%D0%B8/IMG_20250227_124724.jpg)
* **Арифметические/логические операции**
  * Сложение, вычитание - ADD, ADDC, SUB, SUBC
  * Умножение - MUL, MULS, etc
  * ДЕЛЕНИЯ НЕТ, только внешние реалищации
  * Побитовые и, или, xor - AND, OR, XOR
  * Инкременты/декременты - INC, DEC
* **Передача управления**
  * Безусловные переходы - JMP, RJMP, IJMP, CALL, RCALL[^1]
  * Условные переходы
    * Проверка слова состояния - BRNE, BRTC, etc
    * Пропуск следующей команды по условию - SBIC, SBRC, etc
* **Работа с битами**
  * Логический/арифметический/циклический сдвиги - LSR, ASR, ROR, etc
  * Установка битов регистров/флагов - SBI, CBI, SEC, CLC, etc
* **Управление МК** - NOP, SLEEP, WDR[^2]

#### Способы адресации операндов

* Непосредственная - константа в команде
  ````
  ldi r16, 255
  ````

* Прямая регистровая - операнд в регистре, указан в команде
  ````
  mov r1, r0
  ````
  
  ![Pasted image 20250227124640.png](%D0%9F%D0%B8%D0%BA%D1%87%D0%B8/%D0%9B%D0%B5%D0%BA%D1%86%D0%B8%D0%B8/Pasted%20image%2020250227124640.png)
* Прямая - операнд в памяти, в команде указан адрес
  ````
  lds, r1, $025F
  ````
  
  ![Pasted image 20250227124655.png](%D0%9F%D0%B8%D0%BA%D1%87%D0%B8/%D0%9B%D0%B5%D0%BA%D1%86%D0%B8%D0%B8/Pasted%20image%2020250227124655.png)
* Косвенная - операнд в памяти данных, адрес в регистрах X-Z
  ````
  st X, r16
  ````
  
  ![Pasted image 20250227124923.png](%D0%9F%D0%B8%D0%BA%D1%87%D0%B8/%D0%9B%D0%B5%D0%BA%D1%86%D0%B8%D0%B8/Pasted%20image%2020250227124923.png)
* Косвенная с постинкрементом - операнд в памяти данных, адрес в регистрах X-Z, адрес в X-Z инкреметнируется после операции
  ````
  st X+, r16
  ````
  
  ![Pasted image 20250227125420.png](%D0%9F%D0%B8%D0%BA%D1%87%D0%B8/%D0%9B%D0%B5%D0%BA%D1%86%D0%B8%D0%B8/Pasted%20image%2020250227125420.png)
* Косвенная с преддекрементом - операнд в памяти данных, адрес в регистрах X-Z, декремент перед операцией
  ````
  st -X, r16
  ````
  
  ![Pasted image 20250227125307.png](%D0%9F%D0%B8%D0%BA%D1%87%D0%B8/%D0%9B%D0%B5%D0%BA%D1%86%D0%B8%D0%B8/Pasted%20image%2020250227125307.png)
* Косвенная со смещением - операнд в памяти данных, адрес получается из значения Y/Z + смещение из команды
  ````
  std Z+12, r16
  ````
  
  ![Pasted image 20250227125643.png](%D0%9F%D0%B8%D0%BA%D1%87%D0%B8/%D0%9B%D0%B5%D0%BA%D1%86%D0%B8%D0%B8/Pasted%20image%2020250227125643.png)
* Константная адресация памяти программ - адрес байта памяти в регистре Z
  ````
  lpm
  ````
  
  ![Pasted image 20250227125704.png](%D0%9F%D0%B8%D0%BA%D1%87%D0%B8/%D0%9B%D0%B5%D0%BA%D1%86%D0%B8%D0%B8/Pasted%20image%2020250227125704.png)
* Прямая адресация памяти программ - адрес ячейки памяти программ указан в команде
  ````
  jmp LOOP
  call DELAY
  ````
  
  ![Pasted image 20250227125728.png](%D0%9F%D0%B8%D0%BA%D1%87%D0%B8/%D0%9B%D0%B5%D0%BA%D1%86%D0%B8%D0%B8/Pasted%20image%2020250227125728.png)
* Относительная адресация памяти программ - адрес ячейки получается через сумму содержимого PC и смещения из команды
  ````
  rjmp LOOP
  rcall DELAY
  ````
  
  ![Pasted image 20250227125739.png](%D0%9F%D0%B8%D0%BA%D1%87%D0%B8/%D0%9B%D0%B5%D0%BA%D1%86%D0%B8%D0%B8/Pasted%20image%2020250227125739.png)

#### Прерывания

**Прерывание** - передача управления подпрограмме (обработчику прерывания) при поступлении от некоторого устройства сигнала, требующего немедленной обработки
**По расположению устроства**, посылающего прерывание:

* Внутренние - внутреннее устройство МК: таймер, компаратор
* Внешние - устройства вне МК: кнопки, датчики, что угодно ещё
  **Идентификация источника** прерывания:
* Программная - обработчик в процессе осознаёт кто отправил прерывание
* Векторная - каждому источнику - отдельный вектор прерывания [^3]и собственно свой обработчик
  **Таблица векторов прерываний AVR** - в начале Flash памяти

![Pasted image 20250227130636.png](%D0%9F%D0%B8%D0%BA%D1%87%D0%B8/%D0%9B%D0%B5%D0%BA%D1%86%D0%B8%D0%B8/Pasted%20image%2020250227130636.png)

[^1]: Микроприкол - отличие JMP от RJMP:
    JMP - Jump - умеет прыгать внутри всей области адресации программы (~4 миллиона слов) и доступна не на всех AVR.
    RJMP - Relative Jump - прыгает относительно нынешней инструкции в пределах 4 тысяч слов и, судя по всему, доступен везде (адреса в пределах PC - 2K + 1 -- PC + 2K слов)
    C CALL и RCALL та же ебень что и с JMP и RJMP
    Макроприкол - IJMP - Indirect Jump - прыжок по адресу, лежащему в регистре Z

[^2]: NOP - буквально нихера не делать (No OPeration)
    SLEEP - очевидно - прождать чутка
    WDR - ресет сторожевого таймера (WatchDog timer Reset)

[^3]: Вектор прерывания - адрес обработчика
